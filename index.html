<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏™‡πà‡∏•‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡∏™‡∏≥‡πÄ‡∏ô‡∏≤‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ö‡∏ô PDF</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/@pdf-lib/fontkit@1.1.1/dist/fontkit.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background: linear-gradient(135deg, #1a0000 0%, #2d0000 50%, #000000 100%);
            color: #ffffff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: rgba(139, 0, 0, 0.2);
            border-radius: 15px;
            border: 2px solid #8b0000;
            box-shadow: 0 10px 30px rgba(139, 0, 0, 0.3);
        }

        h1 {
            font-size: 32px;
            font-weight: 700;
            color: #ff4444;
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(255, 68, 68, 0.5);
        }

        .developer {
            font-size: 16px;
            color: #ffcccc;
            margin-top: 10px;
        }

        .controls-panel {
            background: rgba(20, 0, 0, 0.8);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid #8b0000;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
        }

        .control-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            padding: 12px 24px;
            border: 2px solid #8b0000;
            background: linear-gradient(135deg, #8b0000 0%, #c00000 100%);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Sarabun', sans-serif;
            font-size: 16px;
            font-weight: 700;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(139, 0, 0, 0.4);
        }

        .btn:hover {
            background: linear-gradient(135deg, #c00000 0%, #ff0000 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 0, 0, 0.5);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn-danger {
            background: linear-gradient(135deg, #8b0000 0%, #a00000 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #006400 0%, #008000 100%);
            border-color: #006400;
        }

        input[type="file"] {
            display: none;
        }

        .file-label {
            padding: 12px 24px;
            border: 2px solid #8b0000;
            background: linear-gradient(135deg, #8b0000 0%, #c00000 100%);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Sarabun', sans-serif;
            font-size: 16px;
            font-weight: 700;
            display: inline-block;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(139, 0, 0, 0.4);
        }

        .file-label:hover {
            background: linear-gradient(135deg, #c00000 0%, #ff0000 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 0, 0, 0.5);
        }

        input[type="color"] {
            width: 60px;
            height: 40px;
            border: 2px solid #8b0000;
            border-radius: 8px;
            cursor: pointer;
            background: #000;
        }

        input[type="text"], input[type="date"], textarea, select {
            padding: 10px 15px;
            border: 2px solid #8b0000;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border-radius: 8px;
            font-family: 'Sarabun', sans-serif;
            font-size: 14px;
            min-width: 200px;
            width: 100%;
        }

        select {
            cursor: pointer;
        }

        select option {
            background: #1a0000;
            color: white;
        }

        textarea {
            min-height: 60px;
            resize: vertical;
        }

        label {
            color: #ffcccc;
            font-weight: 700;
            margin-right: 10px;
        }

        .workspace {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 20px;
            margin-top: 20px;
        }

        .pdf-viewer {
            background: rgba(20, 0, 0, 0.6);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #8b0000;
            overflow-y: auto;
            max-height: 80vh;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
        }

        /* Thumbnail Mode - ‡πÅ‡∏™‡∏î‡∏á‡∏†‡∏≤‡∏û‡πÄ‡∏•‡πá‡∏Å‡πÜ ‡πÄ‡∏´‡πá‡∏ô‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° */
        .pdf-viewer.thumbnail-mode {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
            padding: 15px;
            align-items: start;
            align-content: start;
        }

        .pdf-viewer.thumbnail-mode .page-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .pdf-viewer.thumbnail-mode .page-number {
            margin-bottom: 5px;
            font-size: 11px;
            order: -1;
        }

        .pdf-viewer.thumbnail-mode .page-container {
            width: auto !important;
            height: auto !important;
            max-width: 140px;
            margin-bottom: 0;
            transition: transform 0.2s ease;
            cursor: pointer;
        }

        .pdf-viewer.thumbnail-mode .page-container:hover {
            transform: scale(1.15);
            box-shadow: 0 8px 25px rgba(139, 0, 0, 0.6);
            z-index: 10;
        }

        .pdf-viewer.thumbnail-mode canvas {
            width: 100%;
            height: auto !important;
            max-width: 140px;
        }

        .pdf-viewer.thumbnail-mode .watermark {
            display: none;
        }

        .page-wrapper {
            display: contents;
        }

        .page-container {
            margin-bottom: 30px;
            position: relative;
            display: inline-block;
            background: white;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
        }

        .page-number {
            text-align: center;
            color: #ff4444;
            font-weight: 700;
            margin-top: 10px;
            margin-bottom: 15px;
            font-size: 16px;
        }

        canvas {
            display: block;
            max-width: 100%;
            height: auto;
        }

        .watermark {
            position: absolute;
            cursor: move;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px dashed rgba(255, 68, 68, 0.5);
            border-radius: 5px;
            user-select: none;
            transition: all 0.2s ease;
        }

        .watermark:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #ff4444;
            box-shadow: 0 0 10px rgba(255, 68, 68, 0.5);
        }

        .watermark.active {
            border-color: #ff0000;
            background: rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.7);
        }

        .watermark-text {
            font-family: 'Sarabun', sans-serif;
            white-space: pre-line;
            line-height: 1.5;
            text-align: center;
        }

        .resize-handle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 20px;
            height: 20px;
            background: #ff4444;
            cursor: se-resize;
            border-radius: 0 0 5px 0;
        }

        .sidebar {
            background: rgba(20, 0, 0, 0.8);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #8b0000;
            height: fit-content;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
        }

        .sidebar h3 {
            color: #ff4444;
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 2px solid #8b0000;
            padding-bottom: 10px;
        }

        .sidebar-section {
            margin-bottom: 20px;
        }

        .sidebar-section label {
            display: block;
            margin-bottom: 8px;
            color: #ffcccc;
        }

        .checkbox-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .checkbox-row input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #8b0000;
        }

        .checkbox-row label {
            margin: 0;
            cursor: pointer;
        }

        .mode-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .mode-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #8b0000;
            background: rgba(139, 0, 0, 0.3);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Sarabun', sans-serif;
            font-weight: 700;
            transition: all 0.3s ease;
        }

        .mode-btn.active {
            background: linear-gradient(135deg, #8b0000 0%, #c00000 100%);
            box-shadow: 0 0 15px rgba(255, 68, 68, 0.5);
        }

        .status {
            background: rgba(0, 100, 0, 0.3);
            padding: 10px;
            border-radius: 8px;
            border: 2px solid #006400;
            color: #90EE90;
            text-align: center;
            margin-top: 15px;
            font-weight: 700;
        }

        .font-manager {
            background: rgba(74, 0, 128, 0.3);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #6a00a0;
            margin-bottom: 20px;
        }

        .font-manager h4 {
            color: #cc99ff;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .font-list {
            max-height: 100px;
            overflow-y: auto;
            margin-bottom: 10px;
        }

        .font-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            margin-bottom: 5px;
            font-size: 12px;
        }

        .font-item.active {
            background: rgba(106, 0, 160, 0.5);
            border: 1px solid #cc99ff;
        }

        .font-item button {
            padding: 2px 8px;
            font-size: 11px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            margin-left: 5px;
        }

        .font-item .use-btn {
            background: #006400;
            color: white;
        }

        .font-item .delete-btn {
            background: #8b0000;
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #ffcccc;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        @media (max-width: 1024px) {
            .workspace {
                grid-template-columns: 1fr;
            }
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #ff4444;
            font-size: 18px;
        }

        .spinner {
            border: 4px solid rgba(255, 68, 68, 0.2);
            border-top: 4px solid #ff4444;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .thumbnail-info {
            grid-column: 1 / -1;
            text-align: center;
            padding: 10px;
            color: #ffcccc;
            font-size: 12px;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üîñ ‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏™‡πà‡∏•‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡∏™‡∏≥‡πÄ‡∏ô‡∏≤‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ö‡∏ô PDF</h1>
            <div class="developer">‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢ ‡∏ô‡∏≤‡∏¢‡∏ô‡∏ô‡∏ó‡∏û‡∏±‡∏ó‡∏ò‡πå ‡∏´‡∏¥‡∏£‡∏±‡∏ç‡πÄ‡∏£‡∏∑‡∏≠‡∏á</div>
        </header>

        <div class="controls-panel">
            <div class="control-row">
                <label for="pdfUpload" class="file-label">üìÑ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå PDF</label>
                <input type="file" id="pdfUpload" accept="application/pdf">
                <button class="btn" id="addWatermarkBtn" disabled>‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏≤‡∏¢‡∏ô‡πâ‡∏≥</button>
                <button class="btn" id="exportBtn" disabled>üíæ Export PDF</button>
                <button class="btn" id="thumbnailToggle" disabled>üñºÔ∏è Thumbnail</button>
            </div>

            <div class="control-row">
                <button class="btn btn-danger" id="clearAllBtn" disabled>üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏•‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                <button class="btn" id="moveAllBtn" disabled>üîÑ ‡∏Ç‡∏¢‡∏±‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤</button>
            </div>

            <div class="mode-toggle">
                <button class="mode-btn active" data-mode="all">üåê ‡πÉ‡∏ä‡πâ‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤</button>
                <button class="mode-btn" data-mode="individual">üìÑ ‡πÅ‡∏¢‡∏Å‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤</button>
            </div>
        </div>

        <div class="workspace">
            <div class="pdf-viewer" id="pdfViewer">
                <div class="empty-state">
                    <svg fill="#ffcccc" viewBox="0 0 24 24">
                        <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                    </svg>
                    <p style="font-size: 18px; font-weight: 700;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå PDF</p>
                    <p style="margin-top: 10px; opacity: 0.7;">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå PDF ‡∏ó‡∏∏‡∏Å‡∏Ç‡∏ô‡∏≤‡∏î</p>
                </div>
            </div>

            <div class="sidebar">
                <!-- Font Manager -->
                <div class="font-manager">
                    <h4>üî§ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ü‡∏≠‡∏ô‡∏ï‡πå</h4>
                    <div class="font-list" id="fontList">
                        <div style="color: #aaa; font-size: 12px; text-align: center;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                    </div>
                    <div style="display: flex; gap: 5px;">
                        <label for="fontUpload" class="btn btn-small" style="flex: 1; text-align: center; background: linear-gradient(135deg, #4a0080 0%, #6a00a0 100%); border-color: #6a00a0;">
                            ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏≠‡∏ô‡∏ï‡πå
                        </label>
                        <input type="file" id="fontUpload" accept=".ttf,.otf">
                    </div>
                    <div id="fontStatus" style="font-size: 11px; margin-top: 8px; color: #cc99ff;"></div>
                </div>

                <h3>‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏•‡∏≤‡∏¢‡∏ô‡πâ‡∏≥</h3>
                
                <div class="sidebar-section">
                    <label>‡∏™‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°:</label>
                    <input type="color" id="textColor" value="#003366">
                </div>

                <div class="sidebar-section">
                    <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏ô‡∏≤‡∏°:</label>
                    <input type="text" id="signerName" value="‡∏ô‡∏≤‡∏¢‡∏ô‡∏ô‡∏ó‡∏û‡∏±‡∏ó‡∏ò‡πå ‡∏´‡∏¥‡∏£‡∏±‡∏ç‡πÄ‡∏£‡∏∑‡∏≠‡∏á">
                </div>

                <div class="sidebar-section">
                    <label>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á:</label>
                    <input type="text" id="position" value="‡∏Ñ‡∏£‡∏π">
                </div>

                <div class="sidebar-section">
                    <label>‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö:</label>
                    <textarea id="purpose" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)..."></textarea>
                </div>

                <div class="sidebar-section">
                    <div class="checkbox-row">
                        <input type="checkbox" id="showDate">
                        <label for="showDate">‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏•‡∏≤‡∏¢‡∏ô‡πâ‡∏≥</label>
                    </div>
                    <input type="date" id="signDate">
                </div>

                <div class="status" id="statusText">
                    ‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                </div>
            </div>
        </div>
    </div>

    <script>
        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏ó‡∏µ‡πà
        const RENDER_SCALE = 1.5;
        const DB_NAME = 'PDFWatermarkFonts';
        const DB_VERSION = 1;
        const STORE_NAME = 'fonts';

        // State
        let pdfDoc = null;
        let pdfArrayBuffer = null;
        let currentMode = 'all';
        let watermarks = {};
        let draggedElement = null;
        let dragOffset = { x: 0, y: 0 };
        let resizing = false;
        let thumbnailMode = false;
        let moveAllMode = false;
        let savedFonts = []; // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ
        let activeFontId = null; // ID ‡∏Ç‡∏≠‡∏á‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà
        let activeFontBytes = null; // bytes ‡∏Ç‡∏≠‡∏á‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà
        let pageDimensions = {};

        // DOM Elements
        const pdfUpload = document.getElementById('pdfUpload');
        const fontUpload = document.getElementById('fontUpload');
        const fontStatus = document.getElementById('fontStatus');
        const fontList = document.getElementById('fontList');
        const pdfViewer = document.getElementById('pdfViewer');
        const addWatermarkBtn = document.getElementById('addWatermarkBtn');
        const exportBtn = document.getElementById('exportBtn');
        const thumbnailToggle = document.getElementById('thumbnailToggle');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const moveAllBtn = document.getElementById('moveAllBtn');
        const textColorInput = document.getElementById('textColor');
        const signerNameInput = document.getElementById('signerName');
        const positionInput = document.getElementById('position');
        const purposeInput = document.getElementById('purpose');
        const signDateInput = document.getElementById('signDate');
        const showDateCheckbox = document.getElementById('showDate');
        const modeBtns = document.querySelectorAll('.mode-btn');
        const statusText = document.getElementById('statusText');

        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        signDateInput.valueAsDate = new Date();

        // ================== IndexedDB Functions ==================

        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
                
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                    }
                };
            });
        }

        async function saveFont(name, bytes) {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_NAME, 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                const request = store.add({ name, bytes, createdAt: Date.now() });
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function getAllFonts() {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_NAME, 'readonly');
                const store = tx.objectStore(STORE_NAME);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function getFont(id) {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_NAME, 'readonly');
                const store = tx.objectStore(STORE_NAME);
                const request = store.get(id);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function deleteFont(id) {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_NAME, 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                const request = store.delete(id);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        // ================== Font Manager UI ==================

        async function loadFontList() {
            try {
                savedFonts = await getAllFonts();
                renderFontList();
                
                // ‡πÇ‡∏´‡∏•‡∏î‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                const lastFontId = localStorage.getItem('lastActiveFontId');
                if (lastFontId) {
                    const font = savedFonts.find(f => f.id === parseInt(lastFontId));
                    if (font) {
                        await selectFont(font.id);
                    }
                }
                
                updateFontStatus();
            } catch (err) {
                console.error('Error loading fonts:', err);
                fontList.innerHTML = '<div style="color: #ff6666; font-size: 12px;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</div>';
            }
        }

        function renderFontList() {
            if (savedFonts.length === 0) {
                fontList.innerHTML = `
                    <div style="color: #aaa; font-size: 11px; text-align: center; padding: 10px;">
                        ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å<br>
                        <span style="font-size: 10px; opacity: 0.7;">‡∏à‡∏∞‡πÉ‡∏ä‡πâ Noto Sans Thai ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</span>
                    </div>
                `;
                return;
            }

            fontList.innerHTML = savedFonts.map(font => `
                <div class="font-item ${activeFontId === font.id ? 'active' : ''}" data-id="${font.id}">
                    <span>${font.name}</span>
                    <div>
                        <button class="use-btn" onclick="selectFont(${font.id})">‡πÉ‡∏ä‡πâ</button>
                        <button class="delete-btn" onclick="removeFontConfirm(${font.id})">‡∏•‡∏ö</button>
                    </div>
                </div>
            `).join('');
        }

        async function selectFont(id) {
            try {
                const font = await getFont(id);
                if (font) {
                    activeFontId = font.id;
                    activeFontBytes = font.bytes;
                    localStorage.setItem('lastActiveFontId', id);
                    renderFontList();
                    updateFontStatus();
                }
            } catch (err) {
                console.error('Error selecting font:', err);
            }
        }

        async function removeFontConfirm(id) {
            if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
            
            try {
                await deleteFont(id);
                if (activeFontId === id) {
                    activeFontId = null;
                    activeFontBytes = null;
                    localStorage.removeItem('lastActiveFontId');
                }
                await loadFontList();
            } catch (err) {
                console.error('Error deleting font:', err);
            }
        }

        function updateFontStatus() {
            if (activeFontId && activeFontBytes) {
                const font = savedFonts.find(f => f.id === activeFontId);
                fontStatus.innerHTML = `‚úÖ ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: <strong>${font?.name || '‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å'}</strong>`;
                fontStatus.style.color = '#90EE90';
            } else {
                fontStatus.innerHTML = `‚ÑπÔ∏è ‡πÉ‡∏ä‡πâ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (Noto Sans Thai)`;
                fontStatus.style.color = '#cc99ff';
            }
        }

        // ================== Font Upload ==================

        fontUpload.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            try {
                fontStatus.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ü‡∏≠‡∏ô‡∏ï‡πå...';
                fontStatus.style.color = '#ffcc00';
                
                const bytes = await file.arrayBuffer();
                const id = await saveFont(file.name, bytes);
                
                await loadFontList();
                await selectFont(id);
                
                fontStatus.textContent = `‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${file.name}`;
                fontStatus.style.color = '#90EE90';
                
            } catch (error) {
                console.error('Error saving font:', error);
                fontStatus.textContent = '‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
                fontStatus.style.color = '#ff4444';
            }
            
            fontUpload.value = '';
        });

        // ================== Settings ==================

        function loadSettings() {
            const saved = localStorage.getItem('pdfWatermarkSettings');
            if (saved) {
                const settings = JSON.parse(saved);
                textColorInput.value = settings.textColor || '#003366';
                signerNameInput.value = settings.signerName || '‡∏ô‡∏≤‡∏¢‡∏ô‡∏ô‡∏ó‡∏û‡∏±‡∏ó‡∏ò‡πå ‡∏´‡∏¥‡∏£‡∏±‡∏ç‡πÄ‡∏£‡∏∑‡∏≠‡∏á';
                positionInput.value = settings.position || '‡∏Ñ‡∏£‡∏π';
                purposeInput.value = settings.purpose || '';
                showDateCheckbox.checked = settings.showDate || false;
                if (settings.signDate) {
                    signDateInput.value = settings.signDate;
                }
            }

            const savedWatermarks = localStorage.getItem('pdfWatermarks');
            if (savedWatermarks) {
                watermarks = JSON.parse(savedWatermarks);
            }
        }

        function saveSettings() {
            const settings = {
                textColor: textColorInput.value,
                signerName: signerNameInput.value,
                position: positionInput.value,
                purpose: purposeInput.value,
                signDate: signDateInput.value,
                showDate: showDateCheckbox.checked
            };
            localStorage.setItem('pdfWatermarkSettings', JSON.stringify(settings));
            localStorage.setItem('pdfWatermarks', JSON.stringify(watermarks));
            statusText.textContent = '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥';
        }

        [textColorInput, signerNameInput, positionInput, purposeInput, signDateInput, showDateCheckbox].forEach(input => {
            input.addEventListener('input', saveSettings);
            input.addEventListener('change', saveSettings);
        });

        // ================== PDF Functions ==================

        pdfUpload.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            pdfViewer.innerHTML = '<div class="loading"><div class="spinner"></div>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î PDF...</div>';
            watermarks = {};

            try {
                pdfArrayBuffer = await file.arrayBuffer();
                pdfDoc = await pdfjsLib.getDocument({ data: pdfArrayBuffer.slice(0) }).promise;
                
                await renderPDF();
                addWatermarkBtn.disabled = false;
                exportBtn.disabled = false;
                thumbnailToggle.disabled = false;
                clearAllBtn.disabled = false;
                moveAllBtn.disabled = false;
                
                statusText.textContent = `‚úÖ ‡πÇ‡∏´‡∏•‡∏î PDF ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${pdfDoc.numPages} ‡∏´‡∏ô‡πâ‡∏≤)`;
            } catch (error) {
                console.error('Error loading PDF:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î PDF: ' + error.message);
            }
        });

        async function renderPDF() {
            pdfViewer.innerHTML = '';
            pdfViewer.classList.remove('thumbnail-mode');
            thumbnailMode = false;
            thumbnailToggle.textContent = 'üñºÔ∏è Thumbnail';
            pageDimensions = {};

            for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
                const page = await pdfDoc.getPage(pageNum);
                const viewport = page.getViewport({ scale: RENDER_SCALE });
                
                const originalViewport = page.getViewport({ scale: 1.0 });
                pageDimensions[pageNum] = {
                    width: originalViewport.width,
                    height: originalViewport.height,
                    canvasWidth: viewport.width,
                    canvasHeight: viewport.height
                };

                // Wrapper ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö thumbnail mode
                const pageWrapper = document.createElement('div');
                pageWrapper.className = 'page-wrapper';

                const pageLabel = document.createElement('div');
                pageLabel.className = 'page-number';
                pageLabel.textContent = `‡∏´‡∏ô‡πâ‡∏≤ ${pageNum}`;

                const pageContainer = document.createElement('div');
                pageContainer.className = 'page-container';
                pageContainer.dataset.pageNum = pageNum;
                pageContainer.style.width = viewport.width + 'px';
                pageContainer.style.height = viewport.height + 'px';

                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                await page.render({
                    canvasContext: context,
                    viewport: viewport
                }).promise;
                
                pageContainer.appendChild(canvas);
                pageWrapper.appendChild(pageLabel);
                pageWrapper.appendChild(pageContainer);
                pdfViewer.appendChild(pageWrapper);

                if (watermarks[pageNum]) {
                    watermarks[pageNum].forEach((wm, index) => {
                        addWatermarkElement(pageNum, wm, index);
                    });
                }
            }
        }

        function getWatermarkText() {
            let text = '‡∏™‡∏≥‡πÄ‡∏ô‡∏≤‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
            text += `\n\n(${signerNameInput.value})`;
            text += `\n‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ${positionInput.value}`;
            
            const purpose = purposeInput.value.trim();
            if (purpose) {
                text += `\n${purpose}`;
            }
            
            if (showDateCheckbox.checked) {
                const date = new Date(signDateInput.value);
                const thaiMonths = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
                                  '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
                const day = date.getDate();
                const month = thaiMonths[date.getMonth()];
                const year = date.getFullYear() + 543;
                text += `\n‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${day} ${month} ${year}`;
            }
            
            return text;
        }

        addWatermarkBtn.addEventListener('click', () => {
            if (!pdfDoc) return;

            const defaultX = 50;
            const defaultY = 50;

            if (currentMode === 'all') {
                for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
                    const watermark = {
                        text: getWatermarkText(),
                        color: textColorInput.value,
                        x: defaultX,
                        y: defaultY,
                        scale: 1
                    };

                    if (!watermarks[pageNum]) {
                        watermarks[pageNum] = [];
                    }
                    watermarks[pageNum].push(watermark);
                    addWatermarkElement(pageNum, watermark, watermarks[pageNum].length - 1);
                }
            } else {
                const pageNum = 1;
                const watermark = {
                    text: getWatermarkText(),
                    color: textColorInput.value,
                    x: defaultX,
                    y: defaultY,
                    scale: 1
                };

                if (!watermarks[pageNum]) {
                    watermarks[pageNum] = [];
                }
                watermarks[pageNum].push(watermark);
                addWatermarkElement(pageNum, watermark, watermarks[pageNum].length - 1);
            }

            saveSettings();
            statusText.textContent = '‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡πÅ‡∏•‡πâ‡∏ß';
        });

        function addWatermarkElement(pageNum, watermark, index) {
            const pageContainer = document.querySelector(`[data-page-num="${pageNum}"]`);
            if (!pageContainer) return;

            const wmDiv = document.createElement('div');
            wmDiv.className = 'watermark';
            wmDiv.dataset.pageNum = pageNum;
            wmDiv.dataset.index = index;
            wmDiv.style.left = watermark.x + 'px';
            wmDiv.style.top = watermark.y + 'px';
            wmDiv.style.transform = `scale(${watermark.scale})`;
            wmDiv.style.transformOrigin = 'top left';

            const textDiv = document.createElement('div');
            textDiv.className = 'watermark-text';
            textDiv.style.color = watermark.color;

            const lines = watermark.text.split('\n');
            textDiv.innerHTML = '';
            lines.forEach((line, i) => {
                const span = document.createElement('div');
                span.style.textAlign = 'center';
                
                if (i === 0) {
                    span.style.fontSize = '18px';
                    span.style.fontWeight = '700';
                    span.style.marginBottom = '30px';
                } else if (i === 1) {
                    span.style.minHeight = '10px';
                } else if (line.startsWith('(')) {
                    span.style.fontSize = '14px';
                    span.style.fontWeight = '700';
                } else {
                    span.style.fontSize = '12px';
                    span.style.fontWeight = '700';
                }
                span.textContent = line;
                textDiv.appendChild(span);
            });

            const resizeHandle = document.createElement('div');
            resizeHandle.className = 'resize-handle';

            wmDiv.appendChild(textDiv);
            wmDiv.appendChild(resizeHandle);
            pageContainer.appendChild(wmDiv);

            wmDiv.addEventListener('mousedown', (e) => {
                if (e.target === resizeHandle) {
                    resizing = true;
                    draggedElement = wmDiv;
                } else {
                    draggedElement = wmDiv;
                    const rect = wmDiv.getBoundingClientRect();
                    dragOffset.x = e.clientX - rect.left;
                    dragOffset.y = e.clientY - rect.top;
                    wmDiv.classList.add('active');
                }
                e.preventDefault();
            });

            wmDiv.addEventListener('dblclick', () => {
                if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏•‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                    const pNum = parseInt(wmDiv.dataset.pageNum);
                    const idx = parseInt(wmDiv.dataset.index);
                    watermarks[pNum].splice(idx, 1);
                    if (watermarks[pNum].length === 0) {
                        delete watermarks[pNum];
                    }
                    wmDiv.remove();
                    saveSettings();
                    
                    document.querySelectorAll(`.watermark[data-page-num="${pNum}"]`).forEach((el, newIdx) => {
                        el.dataset.index = newIdx;
                    });
                }
            });
        }

        document.addEventListener('mousemove', (e) => {
            if (!draggedElement) return;

            const pageNum = parseInt(draggedElement.dataset.pageNum);
            const index = parseInt(draggedElement.dataset.index);

            if (resizing) {
                const rect = draggedElement.getBoundingClientRect();
                const newScale = Math.max(0.5, Math.min(3, (e.clientX - rect.left) / 100));
                draggedElement.style.transform = `scale(${newScale})`;
                
                if (watermarks[pageNum] && watermarks[pageNum][index]) {
                    watermarks[pageNum][index].scale = newScale;
                }

                if (moveAllMode) {
                    for (let pNum = 1; pNum <= pdfDoc.numPages; pNum++) {
                        if (pNum !== pageNum && watermarks[pNum] && watermarks[pNum][index]) {
                            watermarks[pNum][index].scale = newScale;
                            const wmElement = document.querySelector(`.watermark[data-page-num="${pNum}"][data-index="${index}"]`);
                            if (wmElement) {
                                wmElement.style.transform = `scale(${newScale})`;
                            }
                        }
                    }
                }
            } else {
                const pageContainer = draggedElement.parentElement;
                const containerRect = pageContainer.getBoundingClientRect();
                
                let newX = e.clientX - containerRect.left - dragOffset.x;
                let newY = e.clientY - containerRect.top - dragOffset.y;

                newX = Math.max(0, newX);
                newY = Math.max(0, newY);

                draggedElement.style.left = newX + 'px';
                draggedElement.style.top = newY + 'px';

                if (watermarks[pageNum] && watermarks[pageNum][index]) {
                    watermarks[pageNum][index].x = newX;
                    watermarks[pageNum][index].y = newY;
                }

                if (moveAllMode) {
                    for (let pNum = 1; pNum <= pdfDoc.numPages; pNum++) {
                        if (pNum !== pageNum && watermarks[pNum] && watermarks[pNum][index]) {
                            watermarks[pNum][index].x = newX;
                            watermarks[pNum][index].y = newY;
                            const wmElement = document.querySelector(`.watermark[data-page-num="${pNum}"][data-index="${index}"]`);
                            if (wmElement) {
                                wmElement.style.left = newX + 'px';
                                wmElement.style.top = newY + 'px';
                            }
                        }
                    }
                }
            }
        });

        document.addEventListener('mouseup', () => {
            if (draggedElement) {
                draggedElement.classList.remove('active');
                draggedElement = null;
                resizing = false;
                saveSettings();
            }
        });

        modeBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                modeBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentMode = btn.dataset.mode;
            });
        });

        thumbnailToggle.addEventListener('click', () => {
            thumbnailMode = !thumbnailMode;
            if (thumbnailMode) {
                pdfViewer.classList.add('thumbnail-mode');
                thumbnailToggle.textContent = 'üìÑ ‡∏õ‡∏Å‡∏ï‡∏¥';
            } else {
                pdfViewer.classList.remove('thumbnail-mode');
                thumbnailToggle.textContent = 'üñºÔ∏è Thumbnail';
            }
        });

        clearAllBtn.addEventListener('click', () => {
            if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏•‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                watermarks = {};
                saveSettings();
                document.querySelectorAll('.watermark').forEach(wm => wm.remove());
                statusText.textContent = '‚úÖ ‡∏•‡∏ö‡∏•‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß';
            }
        });

        moveAllBtn.addEventListener('click', () => {
            moveAllMode = !moveAllMode;
            if (moveAllMode) {
                moveAllBtn.textContent = '‚úÖ ‡∏Ç‡∏¢‡∏±‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô (‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏¥‡∏î)';
                moveAllBtn.classList.add('btn-success');
            } else {
                moveAllBtn.textContent = 'üîÑ ‡∏Ç‡∏¢‡∏±‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤';
                moveAllBtn.classList.remove('btn-success');
            }
        });

        // ================== Export PDF ==================

        exportBtn.addEventListener('click', async () => {
            if (!pdfDoc || !pdfArrayBuffer) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå PDF ‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }

            const hasWatermarks = Object.keys(watermarks).some(key => watermarks[key] && watermarks[key].length > 0);
            if (!hasWatermarks) {
                alert('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏•‡∏≤‡∏¢‡∏ô‡πâ‡∏≥ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡∏Å‡πà‡∏≠‡∏ô Export');
                return;
            }

            exportBtn.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á Export...';
            exportBtn.disabled = true;
            statusText.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...';

            try {
                const { PDFDocument, rgb } = PDFLib;
                
                const pdfDocLib = await PDFDocument.load(pdfArrayBuffer.slice(0));
                pdfDocLib.registerFontkit(fontkit);

                // ‡πÇ‡∏´‡∏•‡∏î‡∏ü‡∏≠‡∏ô‡∏ï‡πå
                let customFont;
                
                if (activeFontBytes) {
                    // ‡πÉ‡∏ä‡πâ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ
                    customFont = await pdfDocLib.embedFont(activeFontBytes);
                } else {
                    // ‡πÉ‡∏ä‡πâ Noto Sans Thai Bold
                    const fontUrl = 'https://fonts.gstatic.com/s/notosansthai/v20/iJWQBXeUZi_OHPqn4wq6hQ2RYi1t_aPcGl8q.ttf';
                    try {
                        const fontResponse = await fetch(fontUrl);
                        if (!fontResponse.ok) throw new Error('Font not found');
                        const fontBytes = await fontResponse.arrayBuffer();
                        customFont = await pdfDocLib.embedFont(fontBytes);
                    } catch {
                        const fallbackUrl = 'https://fonts.gstatic.com/s/notosansthai/v20/iJWnBXeUZi_OHPqn4wq6hQ2RYi5t_aPc.ttf';
                        const fontResponse = await fetch(fallbackUrl);
                        const fontBytes = await fontResponse.arrayBuffer();
                        customFont = await pdfDocLib.embedFont(fontBytes);
                    }
                }

                let totalWatermarks = 0;

                for (const [pageNumStr, pageWatermarks] of Object.entries(watermarks)) {
                    const pageNum = parseInt(pageNumStr);
                    
                    if (!pageWatermarks || pageWatermarks.length === 0) continue;
                    
                    const page = pdfDocLib.getPage(pageNum - 1);
                    const { width: pdfWidth, height: pdfHeight } = page.getSize();

                    for (const wm of pageWatermarks) {
                        const canvasX = wm.x / RENDER_SCALE;
                        const canvasY = wm.y / RENDER_SCALE;
                        
                        const colorMatch = wm.color.match(/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i);
                        const r = colorMatch ? parseInt(colorMatch[1], 16) / 255 : 0;
                        const g = colorMatch ? parseInt(colorMatch[2], 16) / 255 : 0.2;
                        const b = colorMatch ? parseInt(colorMatch[3], 16) / 255 : 0.4;

                        const lines = wm.text.split('\n');
                        
                        const lineData = [];
                        let maxWidth = 0;
                        
                        for (let i = 0; i < lines.length; i++) {
                            const line = lines[i];
                            if (!line.trim() && i !== 1) continue;
                            
                            let fontSize;
                            if (i === 0) {
                                fontSize = 18;
                            } else if (i === 1) {
                                fontSize = 10;
                            } else if (line.startsWith('(')) {
                                fontSize = 14;
                            } else {
                                fontSize = 12;
                            }
                            
                            const scaledFontSize = fontSize * wm.scale;
                            const textWidth = line.trim() ? customFont.widthOfTextAtSize(line, scaledFontSize) : 0;
                            
                            if (textWidth > maxWidth) {
                                maxWidth = textWidth;
                            }
                            
                            lineData.push({
                                text: line,
                                fontSize: scaledFontSize,
                                width: textWidth,
                                isTitle: i === 0,
                                isEmpty: i === 1
                            });
                        }
                        
                        let currentY = pdfHeight - canvasY;
                        const baseX = canvasX;
                        
                        for (let i = 0; i < lineData.length; i++) {
                            const ld = lineData[i];
                            
                            if (ld.isTitle) {
                                currentY -= ld.fontSize;
                            }
                            
                            if (ld.text.trim()) {
                                const centerX = baseX + (maxWidth - ld.width) / 2;
                                
                                page.drawText(ld.text, {
                                    x: centerX,
                                    y: currentY,
                                    size: ld.fontSize,
                                    font: customFont,
                                    color: rgb(r, g, b)
                                });
                                
                                totalWatermarks++;
                            }
                            
                            if (ld.isTitle) {
                                currentY -= ld.fontSize * 2.5;
                            } else if (ld.isEmpty) {
                                currentY -= ld.fontSize * 0.5;
                            } else {
                                currentY -= ld.fontSize * 1.4;
                            }
                        }
                    }
                }

                if (totalWatermarks === 0) {
                    throw new Error('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ß‡∏≤‡∏î‡∏•‡∏á‡πÉ‡∏ô PDF');
                }

                const pdfBytes = await pdfDocLib.save();

                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                
                const downloadLink = document.createElement('a');
                downloadLink.href = url;
                downloadLink.download = '‡∏™‡∏≥‡πÄ‡∏ô‡∏≤‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á_' + Date.now() + '.pdf';
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
                
                window.open(url, '_blank');

                exportBtn.textContent = '‚úÖ Export ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!';
                statusText.textContent = '‚úÖ Export ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!';

                setTimeout(() => {
                    exportBtn.textContent = 'üíæ Export PDF';
                    exportBtn.disabled = false;
                    URL.revokeObjectURL(url);
                }, 3000);

            } catch (error) {
                console.error('Export error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
                exportBtn.textContent = 'üíæ Export PDF';
                exportBtn.disabled = false;
                statusText.textContent = '‚ùå Export ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
            }
        });

        // ================== Initialize ==================

        loadSettings();
        loadFontList();
    </script>
</body>
</html>
